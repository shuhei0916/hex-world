# 既存コードの役割分析

プロジェクトの保守性と可読性を向上させるため、各スクリプトファイルの役割と責務を整理する。

## 1. Hexグリッド基本コンポーネント (ライブラリ層)

これらのスクリプトは、[Red Blob Gamesの六角形グリッドライブラリ](https://www.redblobgames.com/grids/hexagons/)をGDScriptに移植したもので、プロジェクトのグリッドシステムの数学的な基礎を形成している。主にデータオブジェクトとして他のスクリプトから利用される。

- **`scripts/hex.gd` (`RefCounted`)**
  - **役割**: 六角形（Hex）のキューブ座標系 (`q`, `r`, `s`) を定義し、それに関する基本的な数学的演算を提供する。
  - **責務**: 座標のデータ構造、算術演算、隣接・距離計算、回転、線形補間など、グリッド計算の根幹をなすアルゴリズムの提供。

- **`scripts/orientation.gd` (`RefCounted`)**
  - **役割**: グリッドの向き（`pointy-topped` or `flat-topped`）を定義するための変換行列と角度を保持するデータコンテナ。
  - **責務**: Hex座標とピクセル座標の相互変換に使われる行列値の保持。`layout.gd`から利用される。

- **`scripts/layout.gd` (`RefCounted`)**
  - **役割**: Hex座標と画面上のピクセル座標との間の変換を担う。
  - **責務**: `orientation`, `size`, `origin`を保持し、`hex_to_pixel`（Hex→Pixel）および`pixel_to_hex`（Pixel→Hex）の変換機能を提供する。

## 2. グリッド管理とデータ構造 (ロジック・データ層)

グリッドの「論理状態」「グラフ構造」「視覚表現」を分離して扱うクラス群。関心の分離が意識されている。

- **`scripts/grid_manager.gd` (`Node`, シングルトン)**
  - **役割**: グリッド全体の論理的な状態（占有情報など）を管理するシングルトン。
  - **責務**: 全ての有効なHex座標 (`grid_hexes`) と占有されているHex座標 (`occupied_hexes`) の管理。ピースの配置可否判定、配置、削除といった、グリッドの状態を操作・問い合わせるためのAPI提供。

- **`scripts/hex_graph.gd` (`RefCounted`)**
  - **役割**: グリッドをグラフ構造として表現し、主経路探索のために使用される。
  - **責務**: 通行不可能な障害物 (`obstacles`) の管理。あるHexに隣接し、かつ通行可能なHexのリスト (`neighbors`) を提供すること。`AStarPathfinder`にグラフ情報を提供する。

- **`scripts/grid_display.gd` (`Node2D`)**
  - **役割**: グリッドを画面上に視覚的に描画する。
  - **責務**: `HexTile.tscn`をインスタンス化してグリッドを物理的に画面に配置すること。生成したグリッド情報を`GridManager`に登録すること。経路ハイライトなど、視覚的なフィードバックの提供。

## 3. ゲームピースと配置ロジック (ゲームオブジェクト層)

ピースの「定義」「インスタンス」「生成」というライフサイクルを分離して管理する。

- **`scripts/tetrahex_shapes.gd` (`Node`)**
  - **役割**: ゲームに登場する全ピース（テトラヘクス）のマスターデータを定義する。
  - **責務**: ピースの種類 (`enum TetrahexType`)、各ピースの形状（Hexオフセット配列）、色の定義を一元管理する。

- **`scripts/piece.gd` (`Node2D`)**
  - **役割**: グリッド上に配置される個々のピースオブジェクトの振る舞いを定義する。
  - **責務**: 自身の形状と色を保持すること。`GridManager`に問い合わせて、配置可否の確認や配置・削除の依頼を行うこと。

- **`scripts/piece_spawner.gd` (`Node`)**
  - **役割**: 新しいピースを生成（スポーン）するファクトリー。
  - **責務**: 定義されたスポーン位置に、ランダムな種類のピースを生成すること。

## 4. プレイヤー操作とUI (インタラクション層)

MVCパターンに近い形で役割が分離されており、`MainScene`が全体の調整役を担う。

- **`scripts/main_scene.gd` (`Node2D`)**
  - **役割**: ゲームのメインシーンにおけるすべてを統括するコントローラー。
  - **責務**: ゲームの初期セットアップ。プレイヤー入力の検知と、それに応じたカメラ操作やピース配置などの実行。シーン内の各コンポーネント（`GridDisplay`, `PaletteUI`等）との協調動作の指示。ピースのプレビュー表示の管理。

- **`scripts/palette.gd` (`Node`)**
  - **役割**: プレイヤーが使用できるピースのインベントリ（パレット）のデータと状態を管理する（Model）。
  - **責務**: 9つのスロットの状態と、現在アクティブなスロットのインデックスを管理すること。状態変更時に`active_slot_changed`シグナルを発行すること。

- **`scripts/palette_ui.gd` (`Control`)**
  - **役割**: `Palette`のデータを画面上に視覚的に表示する（View）。
  - **責務**: `Palette`の状態を監視し、アクティブスロットのハイライトなど、視覚的なフィードバックをプレイヤーに提供すること。

- **`scripts/hex_tile.gd` (`Node2D`)**
  - **役割**: グリッドを構成する個々の六角形タイルの視覚的な振る舞いを定義する。
  - **責務**: 自身のHex座標を保持すること。ハイライト状態に応じて自身のスプライトの色を変更すること。

## 5. アルゴリズム・ユーティリティ (ユーティリティ層)

特定のゲーム機能を実現するための、再利用可能な汎用アルゴリズム。

- **`scripts/a_star_pathfinder.gd` (`RefCounted`)**
  - **役割**: A*探索アルゴリズムを実装し、グリッド上の2点間の最短経路を計算する。
  - **責務**: `HexGraph`を入力として、`PriorityQueue`を使いながら最短経路を探索し、結果を`Array[Hex]`として返す。

- **`scripts/priority_queue.gd` (`RefCounted`)**
  - **役割**: A*アルゴリズムなどで使用される優先度付きキューのデータ構造を提供する。
  - **責務**: 二分ヒープ（Min-Heap）を実装し、要素を優先度順に効率的に管理する。

---
このドキュメントが、今後の開発においてコードの役割を理解し、一貫性のある設計を維持するための一助となれば幸いです。
