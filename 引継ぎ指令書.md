# 引継ぎ指令書

## プロジェクト状況
- **現在の日付**: 2025-12-26
- **完了したマイルストーン**: 
    - 基礎的なビルドシステム（配置、削除）
    - インベントリと自動生産（BARピース）
    - UI改善（shapez風操作）
    - **アイテム輸送の基本（隣接移動・Push型）**

## 今回の実装内容
### 1. アイテム輸送システム (Push型)
- **概要**: `Piece` クラスの `tick()` 内で、隣接する受け入れ可能なピースへアイテムを自動的に移動させる機能を実装しました。
- **仕様**:
    - **全方向Push**: 全てのピースはデフォルトで周囲6方向へアイテムを押し出そうとします。
    - **転送レート制御**: 転送速度を **1秒に1個** に制限しました（`transfer_rate = 1.0`）。
    - **流量制限**: 1回につき最大1個のアイテムのみ移動し、クールダウンが発生します。
    - **CHESTの挙動**: `TetrahexType.CHEST` はアイテムを保持するのみで、自分からは排出しない（ストレージ専用）設定にしています。

### 2. UI/UX改善
- **右クリック操作**:
    - ピース選択中 -> 選択解除（素手）
    - 素手 -> カーソル下のピースを削除

### 3. テストコード
- `tests/test_piece.gd` 内に `class TestItemTransport` を追加し、輸送ロジックのテストを集約しました。
- 「隣接移動」「CHESTの保持」「流量制限（複数隣接時）」のテストケースをカバー済み。

## 次に取り組むべき課題 (Next Steps)

### 優先度高: コンベアベルトの実装
現在は隣接していれば無条件でアイテムが移動しますが、ゲーム性を高めるために「方向性を持った輸送」が必要です。
- **タスク**:
    - `Conveyor` ピースタイプの追加。
    - `Piece` クラスに `input_directions` / `output_directions` プロパティを追加し、接続を制限するロジックの実装。
    - パレットでの回転操作が、ピースの入出力方向にも反映されるようにする。

### 優先度低: 分配ロジックの改善
複数の出力先がある場合、常に特定の方向（探索順序が早い方）が優先されます。
- **タスク**:
    - ラウンドロビン（均等分配）ロジックの実装。

## 技術的負債・メモ
- **TetrahexShapesの重心**: ピースの回転時に軸がずれて見える問題があります。形状データの座標定義を見直す（中心を(0,0)に寄せる）計画があります。
- **Orphans警告**: テスト実行時に `Orphans`（孤立ノード）の警告が出ています。機能に影響はありませんが、テスト終了時のクリーンアップ処理を見直す余地があります。
